{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventory Management System</title>
    <link rel="stylesheet" href="{% static 'inventory_app/css/home.css' %}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      function filterBySecondColumn() {
        {
          var filterText = document
            .getElementById("searchInput")
            .value.toLowerCase(); // Convert to lowercase
          // var table = document.getElementById("stock_table");
          var tr = document.querySelectorAll("#stock_table>tbody>tr");
          for (var i = 0; i < tr.length; i++) {
            {
              var td = tr[i].getElementsByTagName("td")[1]; // Target the second column (index 1)
              if (td) {
                {
                  var textValue =
                    td.textContent.toLowerCase() || td.innerText.toLowerCase(); // Convert to lowercase
                  if (filterText === "" || textValue.includes(filterText)) {
                    {
                      tr[i].style.display = "";
                    }
                  } else {
                    {
                      tr[i].style.display = "none";
                    }
                  }
                }
              }
            }
          }
        }
      }
    </script>

    <script>
      function filterByThirdColumn() {
        {
          var filterText = document
            .getElementById("searchInput2")
            .value.toLowerCase(); // Convert to lowercase
          // var table = document.getElementById("stock_table");
          // var tr = table.getElementsByTagName("tr");
          
          var tr = document.querySelectorAll(".location_inner_table>tbody>tr");
          console.log(tr)

          for (var i = 0; i < tr.length; i++) {
            {
              var td = tr[i].getElementsByTagName("td")[0]; // Target the second column (index 1)
              if (td) {
                {
                  var textValue =
                    td.textContent.toLowerCase() || td.innerText.toLowerCase(); // Convert to lowercase
                  if (filterText === "" || textValue.includes(filterText)) {
                    {
                      tr[i].style.display = "";
                    }
                  } else {
                    {
                      tr[i].style.display = "none";
                    }
                  }
                }
              }
            }
          }
        }
      }
    </script>
  </head>

  <body>
    <div class="top-container">
      <h1>Inventory Management System</h1>
      <div class="button-container">
        <form action="/withdraw" method="get">
          <button type="submit">Withdrawl</button>
        </form>
        <form action="/admin" method="get">
          <button type="submit">Stock Management</button>
        </form>
        <form action="/order" method="get">
          <button type="submit">Order</button>
        </form>
        <form action="/track" method="get">
          <button type="submit">Track Withdrawl</button>
        </form>
        <form action="/analyze" method="get">
          <button type="submit">Analyse</button>
        </form>
      </div>
    </div>

    <div class="bottom-container">
      <div class="chart-container">
        <h2>Stock Alerts</h2>
        <canvas id="inventoryChart" width="200" height="50"></canvas>
        <br />
        <h2>Items Below Threshold by Location</h2>
        <canvas id="thresholdChart" width="200" height="50"></canvas>
      </div>

      <div class="table-container">
        <h2>Inventory Overview</h2>
        <input
          type="text"
          id="searchInput"
          onkeyup="filterBySecondColumn()"
          placeholder="Search by Item..."
        />
        <input
          type="text"
          id="searchInput2"
          onkeyup="filterByThirdColumn()"
          placeholder="Search by Location..."
        />

        <table id="stock_table" border="1">
          <thead>
            <tr>
              <th>ID</th>
              <th>Item</th>
              <th>Units Available</th>
              <th>Units at Locations</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
            <tr>
              <td>{{ item.id }}</td>
              <td>{{ item.name }}</td>
              <td>{{ item.total_quantity }}</td>
              <td>
                <table class="location_inner_table">
                  {% for entry in item.locations %}
                  <tr>
                    <td>{{ entry.location }}</td>
                    <td>{{ entry.quantity }}</td>
                  </tr>
                  {% endfor %}
                </table>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <script>
      var ctx = document.getElementById('inventoryChart').getContext('2d');
      var inventoryChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: ['On Order - Still Below','On Order', 'Below Minimum', 'Near Minimum (20%)', 'Stock Levels Ok'],
              datasets: [{
                  label: '# of Items',
                  data: [
                      {{ stock_levels.below_minimum_after_order }},
                      {{ stock_levels.above_minimum_after_order }},
                      {{ stock_levels.below_minimum }},
                      {{ stock_levels.near_minimum }},
                      {{ stock_levels.above_minimum }}
                  ],
                  backgroundColor: [
                      'rgba(255, 99, 132, 0.2)',
                      'rgba(54, 162, 235, 0.2)',
                      'rgba(255, 206, 86, 0.2)',
                      'rgba(75, 192, 192, 0.2)'
                  ],
                  borderColor: [
                      'rgba(255, 99, 132, 1)',
                      'rgba(54, 162, 235, 1)',
                      'rgba(255, 206, 86, 1)',
                      'rgba(75, 192, 192, 1)'
                  ],
                  borderWidth: 1
              }]
          },
          options: {
              scales: {
                  y: {
                      beginAtZero: true
                  }
              }
          }
      });
    </script>

    <script>
      var thresholdCtx = document.getElementById('thresholdChart').getContext('2d');
      var thresholdChart = new Chart(thresholdCtx, {
          type: 'bar',
          data: {
              labels: {{ below_minimum_locations|safe }},
              datasets: [{
                  label: 'Items Below Threshold',
                  data: {{ below_threshold_counts|safe }},
                  backgroundColor: 'rgba(255, 159, 64, 0.2)',
                  borderColor: 'rgba(255, 159, 64, 1)',
                  borderWidth: 1
              }]
          },
          options: {
              scales: {
                  y: {
                      beginAtZero: true
                  }
              }
          }
      });
    </script>
  </body>
</html>
